<!doctype html>
<html lang="sv">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Referee Mini Dashboard</title>
<style>
  body{font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:16px; color:#0f172a; background:#f8fafc}
  .wrap{max-width:1000px; margin:auto}
  .row{display:grid; gap:8px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); margin:8px 0}
  .card{background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:12px}
  .kpi{font-size:22px; font-weight:600}
  table{width:100%; border-collapse:collapse; background:#fff; border:1px solid #e2e8f0; border-radius:12px; overflow:hidden}
  th,td{padding:8px 10px; border-bottom:1px solid #e2e8f0; text-align:left}
  thead{background:#f1f5f9; font-weight:600}
  .muted{color:#64748b}
  a{color:#2563eb; text-decoration:none}
  a:hover{text-decoration:underline}
  .pill{display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; background:#e2e8f0; margin-left:6px}
</style>

<div class="wrap">
  <h1>Referee Mini Dashboard</h1>

  <!-- Filter -->
  <div class="row">
    <div class="card">
      <div class="muted">Domare</div>
      <select id="ref"></select>
    </div>
    <div class="card">
      <div class="muted">Från</div>
      <input type="date" id="from">
    </div>
    <div class="card">
      <div class="muted">Till</div>
      <input type="date" id="to">
    </div>
    <div class="card">
      <div class="muted">Snabbval</div>
      <div class="row" style="grid-template-columns:1fr 1fr;">
        <button id="clear">Rensa</button>
        <button id="thisSeason">Denna säsong</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row">
    <div class="card"><div class="muted">Matcher i vyn</div><div id="kpiMatches" class="kpi">—</div></div>
    <div class="card"><div class="muted">Vald domare</div><div id="kpiRef" class="kpi">—</div></div>
    <div class="card"><div class="muted">Topp-partner</div><div id="kpiPartner" class="kpi">—</div></div>
  </div>

  <!-- Matches table -->
  <h3>Matcher</h3>
  <table>
    <thead>
      <tr>
        <th>Datum</th><th>Serie</th><th>Arena</th><th>Hemma</th><th>Borta</th><th>Länk</th>
      </tr>
    </thead>
    <tbody id="rows"><tr><td colspan="6" class="muted">Laddar…</td></tr></tbody>
  </table>

  <!-- Optional aggregate when ingen domare vald -->
  <h3 id="aggTitle" style="display:none">Matcher per domare</h3>
  <table id="aggTable" style="display:none">
    <thead><tr><th>Domare</th><th>Matcher</th></tr></thead>
    <tbody id="aggRows"></tbody>
  </table>
</div>

<script>
(async function(){
  const res = await fetch("./data.json");
  const data = await res.json();

  // Elements
  const selRef = document.getElementById("ref");
  const inputFrom = document.getElementById("from");
  const inputTo = document.getElementById("to");
  const btnClear = document.getElementById("clear");
  const btnSeason = document.getElementById("thisSeason");

  const kpiMatches = document.getElementById("kpiMatches");
  const kpiRef = document.getElementById("kpiRef");
  const kpiPartner = document.getElementById("kpiPartner");

  const rows = document.getElementById("rows");
  const aggTitle = document.getElementById("aggTitle");
  const aggTable = document.getElementById("aggTable");
  const aggRows = document.getElementById("aggRows");

  // Populate referee select
  const refs = ["(alla)", ...data.all_referees];
  selRef.innerHTML = refs.map(r => `<option value="${r}">${r}</option>`).join("");

  // Defaults
  inputFrom.value = data.date_min || "";
  inputTo.value = data.date_max || "";

  // Events
  [selRef, inputFrom, inputTo].forEach(el => el.addEventListener("change", render));
  btnClear.addEventListener("click", () => { selRef.value="(alla)"; inputFrom.value=""; inputTo.value=""; render(); });
  btnSeason.addEventListener("click", () => {
    // enkel “säsong”: från 1 aug till 31 maj runt aktuell period i data
    const min = data.date_min || "";
    const yr = (min ? new Date(min).getFullYear() : new Date().getFullYear());
    inputFrom.value = `${yr}-08-01`;
    inputTo.value = `${yr+1}-05-31`;
    render();
  });

  function withinDate(d, from, to){
    if(!d) return false;
    const x = new Date(d);
    if(from && x < new Date(from)) return false;
    if(to && x > new Date(to)) return false;
    return true;
  }

  function render(){
    const ref = selRef.value || "(alla)";
    const from = inputFrom.value || "";
    const to = inputTo.value || "";

    // Filter
    const filtered = data.matches.filter(m=>{
      if(from || to){
        if(!withinDate(m.date, from, to)) return false;
      }
      if(ref !== "(alla)" && !(m.referees||[]).includes(ref)) return false;
      return true;
    });

    // KPIs
    kpiMatches.textContent = filtered.length || "0";
    kpiRef.textContent = ref === "(alla)" ? "—" : ref;

    // Topp-partner om domare vald
    if(ref !== "(alla)"){
      const count = {};
      for(const m of filtered){
        const partners = (m.referees||[]).filter(x=>x!==ref);
        for(const p of partners) count[p] = (count[p]||0)+1;
      }
      const top = Object.entries(count).sort((a,b)=>b[1]-a[1])[0];
      kpiPartner.innerHTML = top ? `${top[0]} <span class="pill">${top[1]}</span>` : "—";
    } else {
      kpiPartner.textContent = "—";
    }

    // Tabell
    if(filtered.length===0){
      rows.innerHTML = `<tr><td colspan="6" class="muted">Inga matcher i vald vy.</td></tr>`;
    } else {
      rows.innerHTML = filtered
        .sort((a,b)=>(a.date||"").localeCompare(b.date||""))
        .map(m=>`<tr>
          <td>${m.date||""}</td>
          <td>${m.series||""}</td>
          <td>${m.arena||""}</td>
          <td>${m.home||""}</td>
          <td>${m.away||""}</td>
          <td>${m.url?`<a href="${m.url}" target="_blank" rel="noopener">Match</a>`:"—"}</td>
        </tr>`).join("");
    }

    // Enkel sammanställning per domare när ingen domare vald
    if(ref === "(alla)"){
      const cnt = {};
      for(const m of filtered){
        for(const r of (m.referees||[])){
          cnt[r] = (cnt[r]||0)+1;
        }
      }
      const list = Object.entries(cnt).sort((a,b)=>b[1]-a[1]);
      if(list.length){
        aggTitle.style.display = "";
        aggTable.style.display = "";
        aggRows.innerHTML = list.map(([r,n])=>`<tr><td>${r}</td><td>${n}</td></tr>`).join("");
      } else {
        aggTitle.style.display = "none";
        aggTable.style.display = "none";
        aggRows.innerHTML = "";
      }
    } else {
      aggTitle.style.display = "none";
      aggTable.style.display = "none";
      aggRows.innerHTML = "";
    }
  }

  render();
})();
</script>
</html>
