<!doctype html>
<html lang="sv">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Innebandy - domarstatistik</title>

<style>
  /* ===== Lätt, modern palett (endast ljust tema) ===== */
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e6e9f2;
    --accent:#6d28d9;      /* indigo-violett */
    --accent-2:#9333ea;    /* gradientslut */
    --accent-weak:#ede9fe; /* bakgrundston */
  }

  *{box-sizing:border-box}
  body{
    margin:14px;
    font:15px/1.55 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--text); background:var(--bg);
  }
  .wrap{max-width:1100px;margin:auto}

  /* Titel med gradient */
  h1{
    font-size:30px;margin:14px 0 18px;text-align:center;font-weight:900;letter-spacing:.4px;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    -webkit-background-clip:text;background-clip:text;color:transparent;
  }

  .row{display:grid;gap:12px;grid-template-columns:1fr;margin:10px 0}
  @media(min-width:820px){ .row.filters{grid-template-columns:repeat(4,minmax(0,1fr));} }

  .card{
    background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 16px;
    box-shadow:0 4px 10px rgba(0,0,0,.04),0 8px 24px rgba(109,40,217,.04);
  }
  .muted{color:var(--muted);font-size:12px;margin-bottom:6px}

  input[type=date]{
    width:100%;padding:12px 14px;background:var(--card);color:var(--text);
    border:1px solid var(--border);border-radius:10px;outline:none;
    transition:border-color .15s, box-shadow .15s;
    font-size:14px;
    appearance:none;
    -webkit-appearance:none;
  }
  input[type=date]:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 4px color-mix(in oklab, var(--accent) 18%, transparent);
  }

  /* Dropdown för vald domare */
  .ref-select{
    width:100%;
    padding:6px 0;
    border:none;
    background:transparent;
    color:var(--text);
    font-size:18px;
    font-weight:800;
    outline:none;
  }
  .ref-select:focus{
    outline:none;
  }

  /* Tabell */
  .table-wrap{
    width:100%;
    overflow-x:hidden;           /* inget som sticker ut horisontellt */
  }
  table{
    width:100%;
    border-collapse:collapse;background:var(--card);
    border:1px solid var(--border);border-radius:16px;overflow:hidden;
    table-layout:auto;
  }
  thead{background:color-mix(in oklab,var(--accent-weak) 30%, var(--card));color:var(--accent)}
  th,td{padding:11px 12px;border-bottom:1px solid var(--border);text-align:left}
  th{font-weight:800;text-transform:uppercase;letter-spacing:.3px}

  /* Datumkolumn – bredare och ingen radbrytning (desktop) */
  th:first-child, td:first-child{
    white-space:nowrap;
    width:120px;
  }

  .kpi{font-size:22px;font-weight:900}

  .list{
    max-height:420px;overflow:auto;border:1px solid var(--border);
    border-radius:16px;background:var(--card);
    -webkit-overflow-scrolling:touch;
  }
  .item{
    display:flex;justify-content:space-between;align-items:center;
    padding:13px 14px;border-bottom:1px solid var(--border);cursor:pointer;
    transition:background .15s, transform .05s;
  }
  .item:hover{background:color-mix(in oklab,var(--accent-weak) 40%, var(--card))}
  .item:active{transform:translateY(1px)}
  .item.active{background:color-mix(in oklab,var(--accent-weak) 60%, var(--card));font-weight:600}
  .pill{
    display:inline-flex;align-items:center;gap:6px;font:600 12px/1 Inter,system-ui;
    padding:3px 10px;border-radius:999px;
    background:color-mix(in oklab,var(--accent) 10%, var(--card));
    color:var(--accent);
    border:1px solid color-mix(in oklab,var(--accent) 25%, var(--border));
  }

  /* ========= Mobiloptimering ========= */
  @media (max-width:600px){
    body{
      margin:8px;
      font-size:14px;
    }
    h1{
      font-size:24px;
      margin:10px 0 14px;
    }
    .card{
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .kpi{
      font-size:18px;
    }
    .list{
      max-height:320px;
    }
    th,td{
      font-size:13px;
      padding:8px 8px;
    }
    .ref-select{
      font-size:16px;
    }

    /* --- MATCHKORT (MOBILE LAYOUT) --- */
    .table-wrap table{
      border:none;
    }
    thead{
      display:none;   /* Dölj tabellhuvud på mobil */
    }

    tbody tr{
      display:block;
      background:var(--card);
      margin-bottom:14px;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 3px 10px rgba(0,0,0,.08); /* box shadow per kort */
      border:1px solid var(--border);
    }

    tbody td{
      display:flex;
      justify-content:space-between;
      padding:6px 4px;
      border-bottom:none;
      word-break:break-word;
    }

    /* Datum – egen rad med värdet till höger */
    td[data-label="Datum"]{
      font-weight:700;
      font-size:14px;
      padding-bottom:10px;
      margin-bottom:6px;
      border-bottom:1px solid var(--border);
    }
    td[data-label="Datum"]::before{
      content:"Datum";
      font-weight:700;
      color:var(--accent);
      margin-right:10px;
    }

    /* Övriga fält – label till vänster, värde till höger */
    td:not([data-label="Datum"])::before{
      content:attr(data-label);
      font-weight:600;
      color:var(--muted);
      margin-right:10px;
    }
  }
</style>

<div class="wrap">
  <h1>Innebandy - domarstatistik</h1>

  <!-- Filter -->
  <div class="row filters" id="filters">
    <div class="card">
      <div class="muted">Från datum</div>
      <input type="date" id="from" aria-label="Från datum">
    </div>
    <div class="card">
      <div class="muted">Till datum</div>
      <input type="date" id="to" aria-label="Till datum">
    </div>
    <div class="card">
      <div class="muted">Vald domare</div>
      <select id="refSelect" class="ref-select">
        <option value="">(välj domare)</option>
      </select>
    </div>
    <div class="card">
      <div class="muted">Antal matcher (inom datumintervall)</div>
      <div id="kpiCount" class="kpi">—</div>
    </div>
  </div>

  <!-- Lista + tabell -->
  <div class="row">
    <div class="card">
      <div class="muted">Antal matcher per domare (inom datumintervall)</div>
      <div id="toplist" class="list">Laddar…</div>
    </div>
    <div class="card" style="grid-column:1;">
      <div class="muted">Matcher (inom datumintervall, för vald domare)</div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>Datum</th><th>Serie</th><th>Hemmalag</th><th>Bortalag</th><th>Arena</th><th>Domarkollega</th>
          </tr></thead>
          <tbody id="rows">
            <tr><td colspan="6" class="muted">Välj domare i listan eller i menyn.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(async function(){
  const files = await (await fetch("csv/files.json")).json();
  const texts = await Promise.all(files.map(f=>fetch("csv/"+f).then(r=>r.text())));

  // Minimal CSV-parser
  function parseCSV(s){
    const out=[], re=/\s*(?:"([^"]*(?:""[^"]*)*)"|([^,"\r\n]*))\s*(,|\r?\n|$)/g; let m,row=[],head;
    const val=(a,b)=>(a||b||"").replace(/""/g,'"');
    while((m=re.exec(s))){
      row.push(val(m[1],m[2]));
      if(m[3]!==','){
        out.push(row); row=[];
        if(!m[3]) break;
      }
    }
    head=out.shift()||[];
    return out.map(r=>Object.fromEntries(head.map((h,i)=>[h.trim(),(r[i]??"").trim()])));
  }

  // Normalisering
  function norm(rec){
    const g=k=>rec[k]??""; const first=x=>(x||"").split(/[ T]/)[0];
    const refs=(g("Referees")||g("Domare")||g("DomareLista")||"") ||
               [g("Domare1"),g("Domare2"),g("Domare3"),g("Referee1"),g("Referee2"),g("Referee3")]
               .filter(Boolean).join(",");
    return {
      date:first(g("Date")||g("Datum")||g("MatchDate")||g("Start")||g("Kickoff")),
      series:g("Serie")||g("Series")||g("Competition")||"",
      arena:g("Arena")||g("Venue")||g("Hall")||"",
      home:g("Hemmalag")||g("Home")||g("HomeTeam")||g("Hemma")||"",
      away:g("Bortalag")||g("Away")||g("AwayTeam")||g("Borta")||"",
      referees:refs.split(/[;,|]/).map(s=>s.trim()).filter(Boolean)
    };
  }

  const all = texts.flatMap(t=>parseCSV(t).map(norm)).filter(r=>r.date);

  // Dataintervall: max låst till 2025-11-12
  const hardMax = "2025-11-12";
  const minDate = all.reduce((a,b)=> a && a<b.date ? a : b.date, all[0]?.date||"");
  const rawMax = all.reduce((a,b)=> a && a>b.date ? a : b.date, all[0]?.date||"");
  const maxDate = rawMax && rawMax > hardMax ? hardMax : (rawMax || hardMax);

  const $from = document.getElementById("from");
  const $to   = document.getElementById("to");
  const $refSelect = document.getElementById("refSelect");
  const $rows=document.getElementById("rows"),
        $kpi=document.getElementById("kpiCount"),
        $top=document.getElementById("toplist");

  [$from,$to].forEach(el=>{ el.min=minDate; el.max=maxDate; });
  $from.value=minDate;
  $to.value   =maxDate;

  function clamp(){
    if($from.value<minDate) $from.value=minDate;
    if($to.value>maxDate)   $to.value=maxDate;
    if($from.value>$to.value) $from.value=$to.value;
  }

  // Unik lista domare för dropdown (alfabetiskt)
  const allRefs = [...new Set(all.flatMap(m=>m.referees))].sort((a,b)=>a.localeCompare(b,"sv"));
  $refSelect.innerHTML =
    '<option value="">(välj domare)</option>' +
    allRefs.map(n=>`<option value="${n}">${n}</option>`).join("");

  let currentRef = "";

  const inRange=(d,f,t)=>(!f||d>=f)&&(!t||d<=t);

  function renderTop(){
    clamp();
    const f=$from.value,t=$to.value,cnt=new Map();
    for(const m of all){
      if(!inRange(m.date,f,t)) continue;
      for(const r of m.referees) cnt.set(r,(cnt.get(r)||0)+1);
    }
    const arr=[...cnt.entries()].sort((a,b)=>b[1]-a[1]);
    if(!arr.length){ $top.textContent="Inga matcher i valt intervall."; return; }

    $top.innerHTML = arr.map(([name,n])=>`
      <div class="item" data-ref="${name}">
        <span>${name}</span><span class="pill">${n}</span>
      </div>`).join("");

    const items = $top.querySelectorAll(".item");
    items.forEach(el=>{
      if(el.dataset.ref === currentRef) el.classList.add("active");
      el.onclick=()=>{
        currentRef = el.dataset.ref;
        $refSelect.value = currentRef;
        items.forEach(i=>i.classList.remove("active"));
        el.classList.add("active");
        renderMatches();
      };
    });
  }

  function renderMatches(){
    clamp();
    const f=$from.value,t=$to.value;
    const rows=all
      .filter(m=>(!currentRef || m.referees.includes(currentRef)) && inRange(m.date,f,t))
      .sort((a,b)=>(a.date||"").localeCompare(b.date||""));
    $kpi.textContent = currentRef ? rows.length : "—";

    if(!currentRef){
      $rows.innerHTML=`<tr><td colspan="6" class="muted">Välj domare i listan eller i menyn.</td></tr>`;
      return;
    }
    if(!rows.length){
      $rows.innerHTML=`<tr><td colspan="6" class="muted">Inga matcher för ${currentRef} i detta intervall.</td></tr>`;
      return;
    }
    $rows.innerHTML = rows.map(m=>{
      const others=(m.referees||[]).filter(r=>r!==currentRef);
      return `<tr>
        <td data-label="Datum">${m.date}</td>
        <td data-label="Serie">${m.series}</td>
        <td data-label="Hemmalag">${m.home}</td>
        <td data-label="Bortalag">${m.away}</td>
        <td data-label="Arena">${m.arena}</td>
        <td data-label="Domarkollega">${others.join(", ")||"—"}</td>
      </tr>`;
    }).join("");
  }

  // Datumändringar
  ["input","change","blur"].forEach(evt=>{
    $from.addEventListener(evt, ()=>{ clamp(); renderTop(); renderMatches(); });
    $to.addEventListener(evt,   ()=>{ clamp(); renderTop(); renderMatches(); });
  });

  // Dropdownändring – synka listan + scrolla till domaren
  $refSelect.addEventListener("change", ()=>{
    currentRef = $refSelect.value || "";

    const items = $top.querySelectorAll(".item");
    items.forEach(i=>{
      i.classList.toggle("active", i.dataset.ref === currentRef);
    });

    renderMatches();

    const active = $top.querySelector(".item.active");
    if(active){
      active.scrollIntoView({behavior:"smooth", block:"center"});
    }
  });

  clamp();
  renderTop();
  renderMatches();
})();
</script>
</html>
